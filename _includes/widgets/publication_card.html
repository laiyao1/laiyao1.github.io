{% assign publications = include.publications %}
<div class="my-3 p-0 bg-white shadow-sm rounded-sm">
    <h6 class="border-bottom border-gray p-3 mb-0">
        {% if include.title %}{{ include.title }}{% else %}<i class="fas fa-star"></i> Selected Recent Publications{% endif %} 
        <a href="{{ 'publications' | relative_url }}">(view all <i class="fas fa-angle-double-right"></i>)</a>
    </h6>
    {% for item in publications limit:include.limit %}
        {% include widgets/publication_item.html item=item %}    
    {% endfor %}
    <h6 class="d-block p-3 mt-0 text-right">
        <a href="{{ 'publications' | relative_url }}">All publications <i class="fas fa-angle-double-right"></i></a>
    </h6>
</div>

<!-- Citation功能的CSS -->
<style>
.badge {
    display: inline-block;
    padding: 0.25em 0.4em;
    font-size: 0.75rem;  /* 改为固定大小 */
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.25rem;
}

.badge-publication {
    font-size: 0.75rem;  /* 固定大小 */
    border-radius: 10rem;
    margin-left: 0.25rem;
    margin-right: 0.25rem;
}


.badge-pill {
    padding-right: 0.6em;
    padding-left: 0.6em;
    border-radius: 10rem;
}


/* Badge颜色样式 */
.badge-success {
    color: #fff;
    background-color: #28a745;
}

.badge-warning {
    color: #212529;
    background-color: #ffc107;
}

.badge-info {
    color: #fff;
    background-color: #17a2b8;
}

.badge-danger {
    color: #fff;
    background-color: #dc3545;
}

.badge-secondary {
    color: #fff;
    background-color: #6c757d;
}

.badge-primary {
    color: #fff;
    background-color: #007bff;
}

/* Citation badge 样式 */
.citation-badge {
    display: inline-block;
    margin-left: 0.25rem;
}

.citation-badge a {
    text-decoration: none;
    transition: opacity 0.3s ease;
}

.citation-badge a:hover {
    opacity: 0.85;
}
</style>

<!-- Citation功能的JS - 静态版本 -->
<script>
(function() {
    'use strict';
    
    // 使用唯一ID来跟踪已处理的元素，而不是阻止重复初始化
    const PROCESSED_ATTR = 'data-citation-loaded';
    
    function loadCitationData() {
        const possiblePaths = [
            '{{ "/assets/data/publications.json" | relative_url }}',
            '/assets/data/publications.json'
        ];
        
        async function tryFetch(paths) {
            for (let path of paths) {
                try {
                    const response = await fetch(path);
                    if (response.ok) {
                        return await response.json();
                    }
                } catch (error) {
                    console.warn('Failed to load from', path);
                }
            }
            throw new Error('Failed to load publications data');
        }
        
        return tryFetch(possiblePaths);
    }
    
    function updateCitationBadges(data) {
        if (!data || !data.papers) {
            hideUnprocessedBadges();
            return;
        }
        
        // 只处理未处理过的元素
        document.querySelectorAll('[data-paper-id]:not([' + PROCESSED_ATTR + '])').forEach(element => {
            const paperId = element.getAttribute('data-paper-id');
            if (!paperId) return;
            
            // 标记为已处理
            element.setAttribute(PROCESSED_ATTR, 'true');
            
            const paper = data.papers.find(p => p.id === paperId);
            const badgeContainer = element.querySelector('.citation-badge');
            
            if (!badgeContainer) return;
            
            if (!paper || paper.citations === null || paper.citations === undefined) {
                badgeContainer.style.display = 'none';
                return;
            }
            
            const citations = paper.citations;
            const badgeClass = 'badge-info';
            const citationText = `<i class="fas fa-quote-right"></i> ${citations} citation${citations !== 1 ? 's' : ''}`;
            
            if (paper.semantic_scholar && paper.semantic_scholar.paper_id) {
                const s2Url = `https://www.semanticscholar.org/paper/${paper.semantic_scholar.paper_id}`;
                badgeContainer.innerHTML = `<a href="${s2Url}" target="_blank" class="badge badge-pill ${badgeClass}" style="color: white;">${citationText}</a>`;
            } else {
                badgeContainer.innerHTML = `<span class="badge badge-pill ${badgeClass}">${citationText}</span>`;
            }
            badgeContainer.style.display = 'inline-block';
        });
    }
    
    function hideUnprocessedBadges() {
        document.querySelectorAll('[data-paper-id]:not([' + PROCESSED_ATTR + ']) .citation-badge').forEach(badge => {
            badge.style.display = 'none';
        });
    }
    
    function initialize() {
        const unprocessed = document.querySelectorAll('[data-paper-id]:not([' + PROCESSED_ATTR + '])');
        if (unprocessed.length === 0) return;
        
        // 如果已有缓存数据，直接使用
        if (window._citationData) {
            updateCitationBadges(window._citationData);
        } else {
            loadCitationData()
                .then(data => {
                    window._citationData = data;  // 缓存数据
                    updateCitationBadges(data);
                })
                .catch(() => hideUnprocessedBadges());
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }
})();
</script>