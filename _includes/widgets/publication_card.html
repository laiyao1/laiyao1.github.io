{% assign publications = include.publications %}
<div class="my-3 p-0 bg-white shadow-sm rounded-sm">
    <h6 class="border-bottom border-gray p-3 mb-0">
        {% if include.title %}{{ include.title }}{% else %}<i class="fas fa-star"></i> Selected Recent Publications{% endif %} 
        <a href="{{ 'publications' | relative_url }}">(view all <i class="fas fa-angle-double-right"></i>)</a>
    </h6>
    {% for item in publications limit:include.limit %}
        {% include widgets/publication_item.html item=item %}    
    {% endfor %}
    <h6 class="d-block p-3 mt-0 text-right">
        <a href="{{ 'publications' | relative_url }}">All publications <i class="fas fa-angle-double-right"></i></a>
    </h6>
</div>

<!-- Citation功能的CSS -->
<style>
.badge {
    display: inline-block;
    padding: 0.25em 0.4em;
    font-size: 0.75rem;  /* 改为固定大小 */
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.25rem;
}

.badge-publication {
    font-size: 0.75rem;  /* 固定大小 */
    border-radius: 10rem;
    margin-left: 0.25rem;
    margin-right: 0.25rem;
}


.badge-pill {
    padding-right: 0.6em;
    padding-left: 0.6em;
    border-radius: 10rem;
}


/* Badge颜色样式 */
.badge-success {
    color: #fff;
    background-color: #28a745;
}

.badge-warning {
    color: #212529;
    background-color: #ffc107;
}

.badge-info {
    color: #fff;
    background-color: #17a2b8;
}

.badge-danger {
    color: #fff;
    background-color: #dc3545;
}

.badge-secondary {
    color: #fff;
    background-color: #6c757d;
}

.badge-primary {
    color: #fff;
    background-color: #007bff;
}

/* Citation badge 样式 */
.citation-badge {
    display: inline-block;
    margin-left: 0.25rem;
}

.citation-badge a {
    text-decoration: none;
    transition: opacity 0.3s ease;
}

.citation-badge a:hover {
    opacity: 0.85;
}
</style>

<!-- Citation功能的JS - 静态版本 -->
<script>
(function() {
    'use strict';
    
    console.log('=== Citation Script Starting ===');
    
    async function loadCitationData() {
        const paths = [
            '/assets/data/publications.json',
            '{{ "/assets/data/publications.json" | relative_url }}'
        ];
        
        for (let path of paths) {
            try {
                console.log('Trying:', path);
                const response = await fetch(path);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Loaded from:', path);
                    return data;
                }
            } catch (e) {
                console.warn('Failed:', path, e);
            }
        }
        return null;
    }
    
    function updateCitationBadges(data) {
        if (!data || !data.papers) {
            console.error('Invalid data');
            return;
        }
        
        console.log('Papers in JSON:', data.papers.map(p => p.id));
        
        document.querySelectorAll('[data-paper-id]').forEach(element => {
            const paperId = element.getAttribute('data-paper-id');
            const badgeContainer = element.querySelector('.citation-badge');
            
            console.log('Processing:', paperId, 'Badge found:', !!badgeContainer);
            
            if (!badgeContainer) return;
            
            const paper = data.papers.find(p => p.id === paperId);
            
            if (!paper) {
                console.warn('No match for:', paperId);
                badgeContainer.style.display = 'none';
                return;
            }
            
            if (paper.citations === null || paper.citations === undefined) {
                badgeContainer.style.display = 'none';
                return;
            }
            
            const citations = paper.citations;
            const s2Id = paper.semantic_scholar?.paper_id;
            
            if (s2Id) {
                badgeContainer.innerHTML = `<a href="https://www.semanticscholar.org/paper/${s2Id}" target="_blank" class="badge badge-pill badge-info" style="color: white; font-size: 0.75rem; text-decoration: none;"><i class="fas fa-quote-right"></i> ${citations} citation${citations !== 1 ? 's' : ''}</a>`;
            } else {
                badgeContainer.innerHTML = `<span class="badge badge-pill badge-info" style="font-size: 0.75rem;"><i class="fas fa-quote-right"></i> ${citations} citation${citations !== 1 ? 's' : ''}</span>`;
            }
            
            console.log('Updated:', paperId, '→', citations);
        });
    }
    
    async function init() {
        const elements = document.querySelectorAll('[data-paper-id]');
        console.log('Found elements:', elements.length);
        
        if (elements.length === 0) return;
        
        // 打印所有 paper id
        elements.forEach(el => console.log('Paper ID in HTML:', el.getAttribute('data-paper-id')));
        
        const data = await loadCitationData();
        if (data) {
            updateCitationBadges(data);
        } else {
            document.querySelectorAll('.citation-badge').forEach(b => {
                b.innerHTML = '<span class="badge badge-danger" style="font-size: 0.75rem;">Error</span>';
            });
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>